{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h3 class="mb-4 text-success">All Grievances</h3>

  <div class="d-flex justify-content-between mb-3">
    <input type="text" id="searchInput" class="form-control w-100" placeholder="Search by Title or ID">
    <div class="dropdown ms-2">
      <button class="btn btn-success dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        Filter
      </button>
      <ul class="dropdown-menu" aria-labelledby="filterDropdown">
        <li class="dropdown-submenu">
          <a class="dropdown-item dropdown-toggle" href="#">Status</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item filter-option" data-type="status" data-value="">All</a></li>
            <li><a class="dropdown-item filter-option" data-type="status" data-value="Pending">Pending</a></li>
            <li><a class="dropdown-item filter-option" data-type="status" data-value="In Progress">In Progress</a></li>
            <li><a class="dropdown-item filter-option" data-type="status" data-value="Resolved">Resolved</a></li>
          </ul>
        </li>
        <li class="dropdown-submenu">
          <a class="dropdown-item dropdown-toggle" href="#">Location</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item filter-option" data-type="location" data-value="">All</a></li>
            <li><a class="dropdown-item filter-option" data-type="location" data-value="kasaragod">Kasaragod</a></li>
            <li><a class="dropdown-item filter-option" data-type="location" data-value="mangalore">Mangalore</a></li>
            <li><a class="dropdown-item filter-option" data-type="location" data-value="bangalore">Bangalore</a></li>
          </ul>
        </li>
      </ul>
    </div>

    <button class="btn btn-outline-danger ms-2" id="clearFilters">Clear</button>
  </div>

  <table class="table table-bordered table-hover" id="grievanceTable">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Status</th>
        <th>Location</th>
        <th>Likes</th>
        <th>Comments</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for item in grievance_data %}
      <tr>
        <td>{{ item.grievance.id }}</td>
        <td>{{ item.grievance.title }}</td>
        <td>{{ item.grievance.status }}</td>
        <td>{{ item.grievance.location.title() }}</td>
        <td>{{ item.like_count }}</td>
        <td>{{ item.comment_count }}</td>
        <td>
          <a href="{{ url_for('d_view_grievance', id=item.grievance.id) }}" class="btn btn-sm btn-info">View</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const searchInput = document.getElementById("searchInput");
  const clearBtn = document.getElementById("clearFilters");
  const table = document.getElementById("grievanceTable");
  const rows = table.getElementsByTagName("tr");
  let activeFilters = { status: "", location: "" };

  searchInput.addEventListener("keyup", filterTable);

  document.querySelectorAll(".filter-option").forEach(option => {
    option.addEventListener("click", function () {
      const type = this.dataset.type;
      const value = this.dataset.value;
      activeFilters[type] = value;
      filterTable();
    });
  });

  clearBtn.addEventListener("click", function () {
    searchInput.value = "";
    activeFilters = { status: "", location: "" };
    filterTable();
  });

  function filterTable() {
    const searchValue = searchInput.value.toLowerCase();

    for (let i = 1; i < rows.length; i++) {
      const cells = rows[i].getElementsByTagName("td");
      if (!cells.length) continue;

      const id = cells[0].innerText.toLowerCase();
      const title = cells[1].innerText.toLowerCase();
      const status = cells[2].innerText;
      const location = cells[3].innerText.toLowerCase();

      let matchesSearch = id.includes(searchValue) || title.includes(searchValue);
      let matchesStatus = !activeFilters.status || status === activeFilters.status;
      let matchesLocation = !activeFilters.location || location.includes(activeFilters.location.toLowerCase());

      rows[i].style.display = (matchesSearch && matchesStatus && matchesLocation) ? "" : "none";
    }
  }
});
</script>
{% endblock %}
